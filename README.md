# CSV TO ELASTICSEARCH FOOD STORE APPLICATION

## To run this project you need:
- Docker
- Maven
- Java 11

To run the project follow these steps

* run elastisearch on port 9200
```
docker run --name elasticsearch1 -d -p 9200:9200 -e "discovery.type=single-node" elasticsearch:7.6.2
```

* build project using maven in the root of the project:
```
mvn clean package -DskipTests
```
* After that you can run the project from your IDE or any other way you preffer
## Technologies used:
- ElasticSearch - database specified in the task
- Docker - makes it easier for us to run ES
- SpringBoot:
    - spring-boot-starter-batch - for batch processing data
    - lombok - to make our code shorter and cleaner
    - spring-boot-starter-data-elasticsearch - for easier integration with ES
    - openapi-generator-maven-plugin - plugin to generate our API based on specification we give to it (located in rseources/spec folder)

## Structure of project
- controller - here we have FoodStoreController which implements API interface generated by open-api-generator-plugin and it handles our requests and delegates further processing to service layer
- service - layer used for Services in which we do business logic (We dont have much of it in this project but still it is there)
- model - place for all models in our application
- repository - There is FoodStoreRepository which extends ElasticsearchRepository which makes querying documents very easy

## Idea behind implementation

We can identify 3 main things from reading the task

- reading data from csv
- converting it to ES Doc and placing it into ES
- Getting data back from ES (API, Queriying it etc.)

Since we have a lot of reading/writting to do I choose Spring Batch for this task.
This allows us to use multiple threads to read and write data which makes great performance improvements.


## How everything works together

### Batch processing
When application starts it runs the Batch Job. It uses multiple threads to do so and each one gets chunk of data to handle. Each row is read and converted to Dto with fields from csv. After that we process that DTO and convert it to ESDoc. And finally ESDocs get saved into elasticSearchRepository. If Index doesnt exist yet, it gets created with name specified in @Document annotation.

!Note1: Since I think that focus in this task is on batch processing, and dealing with ES i made this job execute on start of application. We could make it execute on our command etc.

So If we run multiple times it is recommended to make simple curl request to delete existing index
```
curl -X DELETE "localhost:9200/test"
```

### Querying the data
!Note To make project simpler i decided to go with one data class FoodStore. It it possible to group some of its data into separate class like Adress for example. But for sake of simplicity i decied to keep everything in one calss so I can focus on important part of this task.

!Note Also in an ideal scenary I would implement Pagination where we return List but once again my focus was on batch processing and ES querying

We basically have 2 queries:
- One to return list of food stores whose name or address (street, city county) partially matches given string
- Second one to return store closest to latitude and longitude we send

Both were pretty easy to do using `ElasticsearchRepository`

For Second one was to group latitude and longitude fields into Object called GeoPoint. Elastisearch has built in mechanism called Geo search which supports actions like sorting/filtering my distance from point A to point B (A and B being longitude and latitude).

Before implementing it this was tested with elasticsearch itself by making this call:


```
curl --location --request POST 'http://localhost:9200/test/_search' \
--header 'Content-Type: application/json' \
--data-raw '{
  "size": 1,                              
  "sort" : [
    {
      "_geo_distance" : {
          "location" : [42.826614,-75.544146],  
          "order" : "asc",                  
          "mode" : "avg",
          "unit" : "km",
          "distance_type" : "arc",
          "ignore_unmapped": true
      }
    }
  ],
  "query" : {
    "match_all" : {}
  }
}'
```
